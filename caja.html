<!DOCTYPE html>
<html lang="es">
<head>

  <!--estilos css-->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
<link rel="stylesheet" href="css/styles.css">

<!-- fin de los estilos css-->
  <meta charset="UTF-8">
  <title>MRS TPV Â· Caja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    :root { --accent: #3b82f6; }
    .btn-cantidad { padding: 2px 12px; margin: 0 5px; }
    .acciones { display: flex; align-items: center; justify-content: center; }
    #categorias, #productos {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
    }
    #productos button { text-align: center; line-height: 1.2; }
    .resumen-cobro {
        background: #f8fafc;
        padding: 1rem;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }
    /* Mejora visual para Verifactu: destacar que el precio es editable */
    .precio-editable {
        cursor: pointer;
        color: var(--accent);
        text-decoration: underline dashed;
    }
    tr td { vertical-align: middle; }
    .right { text-align: right; }
    
    /* Footer fijo para tener siempre el botÃ³n de cobro a la vista */
    footer.cobro-footer {
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 2px solid #e2e8f0;
        padding: 1rem 0;
        z-index: 100;
    }
  </style>
</head>
<body>

  <div id="topbar-app"></div>

<section id="abrir-caja" class="container" style="display:none; margin-top:5rem;">
  <article>
    <header>
      <h3 style="margin:0;">ğŸš€ Apertura de Turno</h3>
    </header>
    <p>Para comenzar a vender, introduce el efectivo inicial disponible en el cajÃ³n.</p>
    <label for="fondo-inicial">
      Efectivo Inicial (â‚¬)
      <input type="number" id="fondo-inicial" step="0.01" placeholder="0.00" autofocus>
    </label>
    <button onclick="abrirCaja()" class="primary">ğŸŸ¢ Confirmar y Abrir Caja</button>
  </article>
</section>

<div id="zona-caja" style="display:none; margin-top: 1rem;">
  <main class="container-fluid" style="padding: 0 20px;">
    <div style="display:flex; justify-content:flex-start; align-items:center; gap:10px; margin-bottom:10px;">
      <h4 style="margin:0;">ğŸ›’ Venta Actual</h4>
    </div>
    <div class="acciones-top" style="display:flex; gap:10px; margin-bottom:10px; flex-wrap:wrap; justify-content:flex-start; align-items:center;">
      <button onclick="aplicarDescuento()" class="secondary" style="min-width:140px; width:auto; display:flex; flex-direction:column; align-items:center; gap:4px; padding:10px;">
        <span style="font-size:22px;">ğŸ·ï¸</span>
        <span>Aplicar descuento</span>
      </button>
      <button onclick="window.location.href='clientes.html'" class="secondary" style="min-width:140px; width:auto; display:flex; flex-direction:column; align-items:center; gap:4px; padding:10px;">
        <span style="font-size:22px;">ğŸ§‘â€ğŸ¤â€ğŸ§‘</span>
        <span>Clientes</span>
      </button>
      <button class="outline" disabled style="min-width:140px; width:auto; display:flex; flex-direction:column; align-items:center; gap:4px; padding:10px;">
        <span style="font-size:22px;">ğŸ‘¤</span>
        <span id="usuario-actual-nombre">â€”</span>
      </button>
      <button onclick="cambiarUsuario()" class="secondary" style="min-width:140px; width:auto; display:flex; flex-direction:column; align-items:center; gap:4px; padding:10px;">
        <span style="font-size:22px;">ğŸ”„</span>
        <span>Cambiar usuario</span>
      </button>
      <input id="buscar-producto" placeholder="Buscar productos..." style="height:88px; padding:8px 12px; width:540px; margin-left:auto;">
    </div>
    <div class="grid grid-caja">
      
      <section>
        <article style="padding: 1rem; margin-bottom: 0;">
            <div style="margin-bottom:10px; display:flex; align-items:center; gap:10px;">
              <span style="font-size:0.9rem; color:#6b7280;">TamaÃ±o panel</span>
              <input type="range" id="panelSplit" min="35" max="75" value="63" style="flex:1;">
              <span id="panelSplitVal" style="font-size:0.9rem; color:#6b7280;">63%</span>
            </div>
 
            <div style="max-height: 350px; overflow-y: auto;">
                <table id="tabla-venta">
                  <thead>
                    
                    <tr>
                      <th>Producto</th>
                      <th style="text-align:center">Cant.</th>
                      <th>Precio</th>
                      <th class="right">Total</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                      </tbody>
                </table>
            </div>

            <div class="resumen-cobro">
                <div style="display:flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                    <span>Base Imponible:</span> <span id="subtotal">0.00 â‚¬</span>
                </div>
                <div style="display:flex; justify-content: space-between; font-size: 0.9rem; color: #666;">
                    <span>IVA (21%):</span> <span id="total-iva">0.00 â‚¬</span>
                </div>
                <hr>
                <div style="display:flex; justify-content: space-between; font-size: 1.6rem;">
                    <strong>TOTAL:</strong> <strong id="total-venta" style="color: var(--accent);">0.00 â‚¬</strong>
                </div>
            </div>

            <div class="pago-card">
                <div class="pago-actions" style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                    <button class="secondary btn-pago outline" onclick="seleccionarPago('efectivo')" style="flex:1; height:48px; font-size:1.05rem;">ğŸ’¶ Efectivo</button>
                    <button class="secondary btn-pago outline" onclick="seleccionarPago('tarjeta')" style="flex:1; height:48px; font-size:1.05rem;">ğŸ’³ Tarjeta</button>
                    <button class="primary" onclick="guardarVenta()" style="flex:1; height:84px; font-size:1.3rem; margin: -6px 0;">ğŸ’¾ COBRAR TICKET</button>
                </div>
                <p style="margin:0 0 8px 0;">Seleccionado: <strong id="pago-seleccionado">â€”</strong></p>
                <div id="bloque-efectivo" style="display:none;">
                  <label style="margin-bottom:0;">Entregado (â‚¬)
                    <input type="number" id="efectivo-entregado" step="0.01" oninput="calcularCambio()" placeholder="0.00" style="margin-bottom:0.5rem;">
                  </label>
                  <p style="margin:0;">Cambio: <strong id="cambio" style="color: green; font-size: 1.2rem;">0.00 â‚¬</strong></p>
                </div>
            </div>
        </article>
      </section>

      <section>
        <h4>Familias</h4>
        <div id="categorias"></div>
        <hr>
        <h4>Productos</h4>
        <div id="productos"></div>
      </section>
      
    </div>
  </main>

  <dialog id="post-cobro">
    <article>
      <header>
        <h4 style="margin:0;">âœ… Venta procesada</h4>
      </header>
      <p id="post-desc" style="margin-top:0.5rem;"></p>
      <div class="grid" style="align-items:end;">
        <label>
          NÃºmero cliente (WhatsApp)
          <input id="post-phone" placeholder="Ej: 34XXXXXXXXX">
        </label>
        <label>
          Documento
          <select id="post-doc-type">
            <option value="ticket">Ticket</option>
            <option value="factura">Factura</option>
          </select>
        </label>
      </div>
      <div style="margin-top:10px;">
        <label>Cliente</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <select id="post-cli-filter">
            <option value="nombre">Nombre</option>
            <option value="movil">MÃ³vil</option>
            <option value="dni_nie">DNI/NIE</option>
            <option value="cif">CIF</option>
          </select>
          <input id="post-cli-buscar" placeholder="Buscar cliente...">
          <button class="outline" onclick="abrirClientes()">Abrir mÃ³dulo</button>
        </div>
        <div id="post-cli-resultados" style="max-height:160px; overflow:auto; margin-top:6px;"></div>
        <small>Seleccionado: <strong id="post-cli-seleccionado">â€”</strong></small>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
        <button onclick="postImprimirTicket()">ğŸ–¨ï¸ Imprimir ticket</button>
        <button onclick="postImprimirFactura()">ğŸ–¨ï¸ Imprimir factura</button>
        <button class="secondary" onclick="postEnviarWhatsApp()">ğŸ“¤ Mandar por WhatsApp</button>
        <button class="secondary" onclick="postCerrar()">Cerrar</button>
      </div>
    </article>
  </dialog>
 
  
</div>

<script src="js/topbar.js" type="module"></script>
<script src="js/auth.js" type="module"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="js/caja.js" type="module"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const slider = document.getElementById("panelSplit");
    const label = document.getElementById("panelSplitVal");
    const grid = document.querySelector(".grid-caja");
    if (!slider || !grid) return;
    function apply() {
      const v = Number(slider.value);
      if (label) label.textContent = v + "%";
      grid.style.display = "grid";
      grid.style.gridTemplateColumns = `minmax(0, ${v}%) minmax(0, ${100 - v}%)`;
    }
    apply();
    slider.addEventListener("input", apply);
  });
</script>


</body>
</html>
